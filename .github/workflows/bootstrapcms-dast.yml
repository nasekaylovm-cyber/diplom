name: DAST - OWASP ZAP

on:
  push:
    branches: ["nasekaylovm-cyber-patch-1"]
  pull_request:
    branches: ["nasekaylovm-cyber-patch-1"]
  workflow_dispatch:
    inputs:
      target-url:
        description: '5.129.250.92'
        required: false
        default: 'http://127.0.0.1:8080'

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test
          MYSQL_EXPLICIT_DEFAULTS_FOR_TIMESTAMP: 1
        ports:
          - 3306:3306

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check rules file existence
        run: |
          if [ ! -f "zap_rules/rules.conf" ]; then
            echo "Error: rules file does not exist"
            exit 1
          fi
          cat zap_rules/rules.conf

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: mbstring, pdo_mysql, xml, curl, json, tokenizer

      - name: Install dependencies
        run: |
          composer clear-cache
          composer install --no-dev --no-scripts --no-interaction --ignore-platform-reqs || true

      - name: Prepare .env and DB
        run: |
          cp .env.example .env || true
          php artisan key:generate || true
          php artisan migrate --force || true

      - name: Start application
        run: |
          nohup php artisan serve --host=0.0.0.0 --port=8080 > /tmp/serve.log 2>&1 &
          sleep 5

      - name: Wait for app
        run: |
          MAX_ATTEMPTS=30
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if curl -sSf http://localhost:8080; then
              echo "Application is up"
              break
            fi
            echo "Waiting for application... ($i/$MAX_ATTEMPTS)"
            sleep 2
          done
          if [ $i -eq $MAX_ATTEMPTS ]; then
            echo "Application failed to start"
            exit 1
          fi

      - name: Run ZAP baseline scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://5.129.250.92'
          rules_file_name: 'zap_rules/rules.conf'
          docker_name: owasp/zap2docker-weekly
          cmd_options: '-a -j'
          fail_action: false
          allow_issue_writing: true
          issue_title: 'ZAP Security Scan Report'

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: '*.html'
          retention-days: 30
